<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WayunaikLearn â€” Aprende Wayuunaiki</title>

<!-- Fuentes e iconos -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-hash" crossorigin="anonymous" referrerpolicy="no-referrer" />

<style>
  :root{
    --bg: #F6F2EC;            /* beige suave */
    --primary: #19A974;      /* verde vibrante (duolingo-like) */
    --accent: #C14953;       /* terracota cultural (detalle) */
    --card:#ffffff;
    --muted:#6B6B6B;
    --glass: rgba(255,255,255,0.86);
    --glass-2: rgba(255,255,255,0.65);
    --shadow: 0 12px 30px rgba(10,20,20,0.06);
    --radius:14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;
    background: linear-gradient(180deg, #FCF8F4 0%, var(--bg) 100%);
    color:#123;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Layout */
  .wrap{max-width:1200px;margin:22px auto;padding:18px}
  header{display:flex;justify-content:space-between;align-items:center;gap:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{
    width:64px;height:64px;border-radius:16px;
    background: linear-gradient(135deg,var(--primary),var(--accent));
    color:white; font-weight:800; display:flex;align-items:center;justify-content:center;
    box-shadow:var(--shadow);
    font-size:20px;
  }
  h1{margin:0;font-size:20px;color:var(--primary)}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  /* Top actions */
  #top-actions{display:flex;gap:10px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn-primary{background:linear-gradient(90deg,var(--primary),#2fd191);color:#fff;box-shadow:0 10px 24px rgba(25,169,116,0.12)}
  .btn-ghost{background:transparent;border:1px solid rgba(25,169,116,0.12);color:var(--primary)}

  /* Main grid */
  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px;margin-top:18px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}

  .panel{
    background:var(--card);
    padding:16px;border-radius:var(--radius);
    box-shadow:var(--shadow);
    position:relative;
  }

  /* User panel */
  .user{display:flex;gap:12px;align-items:center}
  .avatar{
    width:64px;height:64px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    font-weight:800;color:var(--primary);background:linear-gradient(180deg,#fff,#f7fff7);
    border:1px solid rgba(0,0,0,0.04);
    font-size:18px;
  }
  .stats{flex:1}
  .progress-bar{height:10px;background:#f1fbf6;border-radius:10px;overflow:hidden;margin-top:8px}
  .progress-bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));width:0%}

  nav.sidebar{display:flex;flex-direction:column;gap:6px;margin-top:12px}
  nav.sidebar button{background:transparent;border:none;text-align:left;padding:10px;border-radius:10px;cursor:pointer;font-weight:700;color:#234}
  nav.sidebar button.active{background:linear-gradient(90deg, rgba(25,169,116,0.09), rgba(193,73,83,0.02))}

  /* Main content */
  main{min-height:64vh}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:12px}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:12px;align-items:center}

  /* Lessons */
  .lesson-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .tile{
    border-radius:12px;padding:12px;background:linear-gradient(180deg,#fff,#fbfffb);
    border-left:6px solid var(--primary);
    box-shadow: 0 8px 20px rgba(10,20,20,0.03);cursor:pointer;
    transition:transform .14s ease, box-shadow .14s ease;
  }
  .tile:hover{transform:translateY(-6px);box-shadow:0 16px 40px rgba(10,20,20,0.06)}
  .tile.locked{opacity:0.5;filter:grayscale(20%);cursor:default;border-left-color:#ddd}

  /* Exercise area */
  .exercise {padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fcfffb);box-shadow:0 8px 20px rgba(10,20,20,0.03)}
  .question{font-size:18px;margin-bottom:10px}
  .options{display:grid;gap:10px}
  .option{padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:#fff}
  .option.correct{background:linear-gradient(90deg,#e7f9ef,#d8f2e3);border-color:rgba(25,169,116,0.12)}
  .option.wrong{background:linear-gradient(90deg,#ffecec,#ffe0e0);border-color:rgba(193,73,83,0.12)}

  /* Dictionary */
  .dictionary-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfffd);margin-bottom:8px}

  /* Profile/Admin forms */
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);margin-top:6px;font-size:14px}
  textarea{resize:vertical}

  footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}

  /* small screens */
  @media (max-width:520px){
    .logo{width:48px;height:48px;font-size:16px}
    .avatar{width:56px;height:56px}
  }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="brand">
      <div class="logo">WL</div>
      <div>
        <h1>WayunaikLearn</h1>
        <p class="lead">Aprenda Wayuunaiki â€” aplicaciÃ³n gamificada y cultural</p>
      </div>
    </div>

    <div id="top-actions">
      <!-- botones dinÃ¡micos -->
    </div>
  </header>

  <div class="grid">
    <!-- PANEL LATERAL -->
    <aside class="panel" aria-label="Panel lateral">
      <div id="auth-area">
        <!-- formulario de login/registro (renderizado por JS) -->
      </div>

      <div id="user-panel" style="display:none">
        <div class="user">
          <div id="avatar" class="avatar">WL</div>
          <div class="stats">
            <div id="welcome"><strong>Bienvenido</strong></div>
            <div id="role" class="muted">Usuario</div>
            <div class="progress-bar"><i id="progbar"></i></div>
            <div class="muted" style="font-size:13px;margin-top:6px" id="xptext">XP: 0 Â· Nivel 1</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btn-continue"><i class="fa-solid fa-play"></i> Continuar</button>
          <button class="btn btn-ghost" id="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesiÃ³n</button>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Racha</div>
          <div style="font-weight:900;font-size:20px">ðŸ”¥ <span id="streak">0</span> dÃ­as</div>
        </div>

        <nav class="sidebar" aria-label="NavegaciÃ³n">
          <button class="active" data-view="dashboard">Dashboard</button>
          <button data-view="lessons">Lecciones</button>
          <button data-view="dictionary">Diccionario</button>
          <button data-view="profile">Perfil</button>
          <button data-view="admin">Admin</button>
        </nav>

        <div style="margin-top:12px">
          <button class="btn btn-ghost small" id="backup-btn"><i class="fa-solid fa-cloud-arrow-up"></i> Exportar / Importar</button>
        </div>
      </div>

      <div style="margin-top:12px" class="muted">WayunaikLearn â€¢ Demo local â€” CorreQ</div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <main>
      <!-- DASHBOARD -->
      <section id="view-dashboard" class="card" role="region" aria-label="Dashboard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">Bienvenido a WayunaikLearn</h2>
            <p class="muted" id="dash-sub">Practique diariamente y avance con metas claras.</p>
          </div>
          <div style="text-align:right">
            <div class="muted">Meta diaria</div>
            <div style="font-weight:900;font-size:20px">20 XP</div>
          </div>
        </div>

        <div style="margin-top:14px" class="card">
          <div style="display:flex;gap:18px;flex-wrap:wrap">
            <div><div class="muted">Nivel</div><div style="font-weight:900;font-size:20px" id="dash-level">1</div></div>
            <div><div class="muted">XP</div><div style="font-weight:900;font-size:20px" id="dash-xp">0</div></div>
            <div><div class="muted">Lecciones completadas</div><div style="font-weight:900;font-size:20px" id="dash-completed">0</div></div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h3 style="margin:0 0 10px 0">Continuar</h3>
          <div id="continue-area" class="muted">Inicie una lecciÃ³n desde el panel de Lecciones.</div>
        </div>
      </section>

      <!-- LECCIONES -->
      <section id="view-lessons" class="card" style="display:none" role="region" aria-label="Lecciones">
        <h2>Lecciones y niveles</h2>
        <p class="muted">Complete lecciones para ganar XP y desbloquear contenido.</p>

        <div style="margin-top:12px" class="card">
          <h4 style="margin:0 0 8px 0">Niveles</h4>
          <div id="levels-list" class="lesson-list"></div>
        </div>

        <div id="lesson-area" class="card" hidden>
          <button class="btn btn-ghost small" id="close-lesson">&larr; Volver</button>
          <h3 id="lesson-title"></h3>
          <p class="muted" id="lesson-desc"></p>
          <div id="exercise-area" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- DICCIONARIO -->
      <section id="view-dictionary" class="card" style="display:none" role="region" aria-label="Diccionario">
        <h2>Diccionario EspaÃ±ol â†” Wayuunaiki</h2>
        <input id="dict-search" placeholder="Buscar palabra (espaÃ±ol o wayu)" />
        <div id="dict-list" style="margin-top:10px"></div>
      </section>

      <!-- PERFIL -->
      <section id="view-profile" class="card" style="display:none" role="region" aria-label="Perfil">
        <h2>Perfil</h2>
        <div class="muted">Edite su perfil</div>
        <label style="margin-top:10px">Nombre</label>
        <input id="profile-name" />
        <label style="margin-top:8px">Iniciales (avatar)</label>
        <input id="profile-initials" maxlength="2" />
        <div style="margin-top:8px">
          <button class="btn btn-primary" id="save-profile">Guardar perfil</button>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="view-admin" class="card" style="display:none" role="region" aria-label="Administrador">
        <h2>Panel administrativo (local)</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="card">
            <h4>Crear nivel</h4>
            <input id="new-level-name" placeholder="Nombre nivel (ej. BÃ¡sico 1)" />
            <textarea id="new-level-desc" placeholder="DescripciÃ³n" style="height:80px"></textarea>
            <button class="btn btn-primary" id="create-level">Crear nivel</button>
          </div>
          <div class="card">
            <h4>Crear lecciÃ³n</h4>
            <select id="sel-level"></select>
            <input id="new-lesson-title" placeholder="TÃ­tulo lecciÃ³n" />
            <textarea id="new-lesson-body" placeholder="DescripciÃ³n/Contenido" style="height:80px"></textarea>
            <button class="btn btn-primary" id="create-lesson">Crear lecciÃ³n</button>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h4>Agregar palabra al diccionario</h4>
          <input id="dict-es" placeholder="EspaÃ±ol" />
          <input id="dict-wy" placeholder="Wayuunaiki (transcripciÃ³n)" />
          <button class="btn btn-primary" id="create-word">Agregar palabra</button>
        </div>

        <div style="margin-top:12px" class="card">
          <h4>Importar contenido de ejemplo</h4>
          <button class="btn small" id="seed-demo">Cargar demo</button>
          <button class="btn small" id="clear-data">Borrar todo (reset)</button>
        </div>
      </section>

    </main>
  </div>

  <footer>WayunaikLearn â€” Demo local Â· Hecho por CorreQ Â· 2025</footer>
</div>

<!-- =========================
     Script principal (todo en un archivo)
     ========================= -->
<script>
/*
  WayunaikLearn - Single file app
  - Local storage based
  - Gamified: XP, niveles, racha
  - Lecciones: MCQ, texto, escucha
  - Diccionario con TTS (SpeechSynthesis)
  - Panel admin local
  - Export / Import JSON
  - Recursos (imÃ¡genes) obtenidos desde Internet en la UI
*/

// Keys de almacenamiento
const STORAGE_KEY = 'wayunaik_data_v2';
const USER_KEY = 'wayunaik_current_user_v2';

// Estructura de datos por defecto
const defaults = {
  users: {},
  levels: [],
  lessons: [],
  exercises: [],
  dictionary: [],
  results: {}
};

// Cargar / guardar
function loadData(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : structuredClone(defaults);
  } catch(e){
    console.error('Error loadData', e);
    return structuredClone(defaults);
  }
}
function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

// Inicializar si vacÃ­o
let data = loadData();
function ensureDemoIfEmpty(){
  if (data.levels.length === 0){
    seedDemo();
  }
}
ensureDemoIfEmpty();
saveData(data);

/* Estado */
let state = {
  currentUser: null,
  currentView: 'dashboard',
  currentLesson: null,
  sessionIndex: 0
};

/* Util selectores */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

/* Inicial */
init();

function init(){
  renderAuthArea();
  renderTopActions();
  bindSideNav();
  renderLevels();
  renderDictionary();
  renderAdminSelect();
  bindButtons();
  restoreSession();
  showView('dashboard');
}

/* ------------------------
   AUTH (local)
   ------------------------ */
function renderAuthArea(){
  $('#auth-area').innerHTML = `
    <div id="login-card" class="card">
      <h3>Iniciar sesiÃ³n</h3>
      <input id="login-user" placeholder="Usuario (ej: juan)" />
      <input id="login-pass" placeholder="ContraseÃ±a" type="password" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary" id="btn-login">Ingresar</button>
        <button class="btn btn-ghost" id="btn-show-register">Registrar</button>
      </div>
      <p class="muted" style="margin-top:8px">Para demo, marque 'Crear como admin' en registro.</p>
    </div>
    <div id="register-card" class="card" style="display:none">
      <h3>Crear cuenta</h3>
      <input id="reg-user" placeholder="Usuario (ej: juan)" />
      <input id="reg-pass" placeholder="ContraseÃ±a" type="password" />
      <label style="display:flex;align-items:center;gap:8px;margin-top:8px"><input id="reg-admin" type="checkbox" /> Crear como admin</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary" id="btn-create">Crear</button>
        <button class="btn btn-ghost" id="btn-cancel-create">Cancelar</button>
      </div>
    </div>
  `;
  // eventos
  $('#btn-show-register').onclick = ()=>{ $('#login-card').style.display='none'; $('#register-card').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}) };
  $('#btn-cancel-create').onclick = ()=>{ $('#login-card').style.display='block'; $('#register-card').style.display='none' };
  $('#btn-create').onclick = createAccount;
  $('#btn-login').onclick = ()=> { const u = $('#login-user').value.trim(), p = $('#login-pass').value; signInLocal(u, p) };
}

function createAccount(){
  const username = $('#reg-user').value.trim();
  const pass = $('#reg-pass').value;
  const isAdmin = $('#reg-admin').checked;
  if (!username || !pass) return alert('Complete usuario y contraseÃ±a.');
  if (!/^[\w\-\.]{2,30}$/.test(username)) return alert('Usuario invÃ¡lido (solo letras, nÃºmeros, guiÃ³n o punto).');
  if (data.users[username]) return alert('Usuario ya existe.');
  const user = { username, pass, initials: initialsFrom(username), isAdmin, xp:0, level:1, streak:0, completed:[], lastLessonId:null, lastLessonTitle:null, createdAt:Date.now() };
  data.users[username] = user; saveData(data);
  alert('Cuenta creada correctamente. Inicie sesiÃ³n.');
  $('#reg-user').value = $('#reg-pass').value = ''; $('#reg-admin').checked=false;
  $('#login-card').style.display='block'; $('#register-card').style.display='none';
}

function signInLocal(username, password){
  if (!username) return alert('Ingrese usuario.');
  const u = data.users[username];
  if (!u) return alert('Usuario no encontrado.');
  // demo: no validamos contraseÃ±a severamente (pero se compara)
  if (u.pass !== password) return alert('ContraseÃ±a incorrecta.');
  state.currentUser = username;
  localStorage.setItem(USER_KEY, JSON.stringify({ username }));
  onLogin();
}

function logout(){
  state.currentUser = null;
  localStorage.removeItem(USER_KEY);
  onLogout();
}

/* ------------------------
   On login/out UI
   ------------------------ */
function onLogin(){
  $('#auth-area').style.display='none';
  $('#user-panel').style.display='block';
  renderTopActions();
  renderSideNavInfo();
  renderLevels();
  renderDictionary();
  renderAdminSelect();
  showView('dashboard');
}

function onLogout(){
  $('#auth-area').style.display='block';
  $('#user-panel').style.display='none';
  renderTopActions();
  showView('dashboard');
}

/* Restore session if exists */
function restoreSession(){
  const cur = localStorage.getItem(USER_KEY);
  if (cur){
    try {
      const obj = JSON.parse(cur);
      if (obj && obj.username && data.users[obj.username]) {
        state.currentUser = obj.username;
        onLogin();
      }
    } catch(e){}
  }
}

/* ------------------------
   Top actions
   ------------------------ */
function renderTopActions(){
  const top = $('#top-actions'); top.innerHTML='';
  if (!state.currentUser){
    const btn = document.createElement('button'); btn.className='btn btn-ghost'; btn.textContent='Iniciar / Registrar';
    btn.onclick = ()=>{ window.scrollTo({top:0,behavior:'smooth'}) };
    top.appendChild(btn);
  } else {
    const u = data.users[state.currentUser];
    const span = document.createElement('div'); span.className='muted'; span.textContent = `${u.username} ${u.isAdmin?'Â· Admin':''}`;
    const btnOut = document.createElement('button'); btnOut.className='btn'; btnOut.textContent='Cerrar sesiÃ³n';
    btnOut.onclick = ()=>logout();
    top.appendChild(span); top.appendChild(btnOut);
  }
}

/* ------------------------
   Side nav
   ------------------------ */
function bindSideNav(){
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if (t.matches('nav.sidebar button')){
      document.querySelectorAll('nav.sidebar button').forEach(b=>b.classList.remove('active'));
      t.classList.add('active');
      showView(t.dataset.view);
    }
  });
  $('#btn-logout').onclick = ()=>logout();
  $('#btn-continue').onclick = ()=> {
    if (!state.currentUser) return alert('Inicie sesiÃ³n para continuar.');
    const u = data.users[state.currentUser];
    if (u.lastLessonId) openLessonById(u.lastLessonId); else { showView('lessons'); }
  };
  $('#backup-btn').onclick = ()=> exportImportDialog();
}

/* ------------------------
   Render user info
   ------------------------ */
function renderSideNavInfo(){
  if (!state.currentUser) return;
  const u = data.users[state.currentUser];
  $('#avatar').textContent = u.initials || initialsFrom(u.username);
  $('#welcome').innerHTML = `<strong>${u.username}</strong>`;
  $('#role').textContent = u.isAdmin ? 'Administrador' : 'Usuario';
  $('#progbar').style.width = Math.min(100, Math.round((u.xp%100))) + '%';
  $('#xptext').textContent = `XP: ${u.xp} Â· Nivel ${u.level}`;
  $('#streak').textContent = u.streak || 0;
  $('#dash-level').textContent = u.level;
  $('#dash-xp').textContent = u.xp;
  $('#dash-completed').textContent = (u.completed||[]).length;
  // continue area
  $('#continue-area').textContent = u.lastLessonTitle ? `Ãšltima lecciÃ³n: ${u.lastLessonTitle}` : 'Comience una lecciÃ³n desde Lecciones.';
}

/* ------------------------
   Vistas
   ------------------------ */
function showView(v){
  state.currentView = v;
  const views = ['dashboard','lessons','dictionary','profile','admin'];
  views.forEach(name => {
    const elv = document.getElementById('view-'+name);
    if (elv) elv.style.display = (name === v ? 'block' : 'none');
  });
  if (v === 'dashboard' && state.currentUser) renderSideNavInfo();
}

/* ------------------------
   Levels & lessons
   ------------------------ */
function renderLevels(){
  const container = $('#levels-list'); if(!container) return;
  container.innerHTML = '';
  data.levels.forEach(level=>{
    const div = document.createElement('div'); div.className='tile';
    const completedCount = data.lessons.filter(l=>l.levelId===level.id && (state.currentUser && data.users[state.currentUser].completed.includes(l.id))).length;
    div.innerHTML = `<strong>${level.name}</strong><div class="muted">${level.desc||''}</div><div style="margin-top:8px;font-size:13px;color:var(--muted)">${completedCount} lecciones completadas</div>`;
    div.onclick = ()=> openLevel(level.id);
    container.appendChild(div);
  });
}

function openLevel(levelId){
  const lessons = data.lessons.filter(l=>l.levelId===levelId);
  const area = $('#lesson-area'); area.hidden=false;
  $('#lesson-title').textContent = (data.levels.find(l=>l.id===levelId)||{}).name || '';
  $('#lesson-desc').textContent = 'Seleccione una lecciÃ³n';
  const exArea = $('#exercise-area'); exArea.innerHTML = '';
  lessons.forEach(ls=>{
    const node = document.createElement('div'); node.className='tile';
    node.innerHTML = `<strong>${ls.title}</strong><div class="muted">${ls.body||''}</div>`;
    node.onclick = ()=> openLesson(ls.id);
    exArea.appendChild(node);
  });
  $('#close-lesson').onclick = ()=>{ area.hidden=true; };
  showView('lessons');
}

/* Open lesson */
function openLessonById(id){
  const lesson = data.lessons.find(l=>l.id===id);
  if (lesson) openLesson(lesson.id);
}

function openLesson(lessonId){
  const lesson = data.lessons.find(l=>l.id===lessonId);
  if (!lesson) return alert('LecciÃ³n no encontrada.');
  $('#lesson-area').hidden=false;
  $('#lesson-title').textContent = lesson.title;
  $('#lesson-desc').textContent = lesson.body || '';
  state.currentLesson = lesson;
  // store last lesson for user
  if (state.currentUser){
    const u = data.users[state.currentUser];
    u.lastLessonId = lesson.id; u.lastLessonTitle = lesson.title; saveData(data);
    renderSideNavInfo();
  }
  // load exercises for lesson
  const exs = data.exercises.filter(e=>e.lessonId===lesson.id);
  if (exs.length===0) { $('#exercise-area').innerHTML='<div class="muted">No hay ejercicios en esta lecciÃ³n.</div>'; return; }
  state.sessionIndex = 0;
  renderExercise(exs[state.sessionIndex], exs);
}

/* ------------------------
   Exercises
   ------------------------ */
function renderExercise(ex, list){
  const area = $('#exercise-area'); area.innerHTML='';
  const q = document.createElement('div'); q.className='question'; q.textContent = ex.prompt;
  area.appendChild(q);

  const meta = document.createElement('div'); meta.className='muted'; meta.style.fontSize='13px'; meta.textContent = `Tipo: ${ex.type} Â· XP: ${ex.xp||10}`; area.appendChild(meta);

  const opts = document.createElement('div'); opts.className='options'; opts.style.marginTop='12px';

  if (ex.type === 'mcq'){
    ex.options.forEach((opt, idx)=>{
      const b = document.createElement('div'); b.className='option'; b.textContent = opt;
      b.onclick = async ()=>{
        const correct = idx === ex.correctIndex;
        b.classList.add(correct? 'correct':'wrong');
        await afterAnswer(correct, ex);
        setTimeout(()=> nextExercise(list), 700);
      };
      opts.appendChild(b);
    });
  } else if (ex.type === 'text'){
    const inp = document.createElement('input'); inp.placeholder='Escriba su respuesta';
    const send = document.createElement('button'); send.className='btn btn-primary'; send.textContent='Enviar';
    send.onclick = async ()=>{
      const ans = inp.value.trim();
      const correct = ex.answer && ans.toLowerCase() === ex.answer.toLowerCase();
      if (correct) inp.style.borderColor='rgba(25,169,116,0.3)'; else inp.style.borderColor='rgba(193,73,83,0.3)';
      await afterAnswer(correct, ex);
      setTimeout(()=> nextExercise(list),700);
    };
    opts.appendChild(inp); opts.appendChild(send);
  } else if (ex.type === 'listen'){
    const play = document.createElement('button'); play.className='btn'; play.textContent='ðŸ”Š Reproducir';
    play.onclick = ()=> speak(ex.prompt);
    const inp = document.createElement('input'); inp.placeholder='Transcriba lo que escuchÃ³';
    const send = document.createElement('button'); send.className='btn btn-primary'; send.textContent='Enviar';
    send.onclick = async ()=>{
      const correct = ex.answer && inp.value.trim().toLowerCase()===ex.answer.toLowerCase();
      await afterAnswer(correct, ex);
      setTimeout(()=> nextExercise(list),700);
    };
    opts.appendChild(play); opts.appendChild(inp); opts.appendChild(send);
  }

  area.appendChild(opts);
}

/* Update user XP, results */
async function afterAnswer(correct, ex){
  if (!state.currentUser) { alert('Inicie sesiÃ³n para guardar progreso.'); return; }
  const u = data.users[state.currentUser];
  const xpGain = correct ? (ex.xp || 10) : -2;
  u.xp = Math.max(0, (u.xp || 0) + xpGain);
  if (correct) {
    u.streak = (u.streak||0) + 1;
    // marcar completada la lecciÃ³n
    u.completed = u.completed || [];
    if (!u.completed.includes(state.currentLesson.id)) u.completed.push(state.currentLesson.id);
  } else {
    u.streak = 0;
  }
  // level up cada 100 XP
  if (u.xp >= u.level * 100) { u.level = u.level + 1; alert('Â¡Felicitaciones! SubiÃ³ de nivel.'); }

  // save results
  data.users[state.currentUser] = u;
  data.results[state.currentUser] = data.results[state.currentUser] || [];
  data.results[state.currentUser].push({ exerciseId: ex.id, correct, at: Date.now() });
  saveData(data);
  renderSideNavInfo();
}

/* next exercise */
function nextExercise(list){
  state.sessionIndex++;
  if (state.sessionIndex < list.length) renderExercise(list[state.sessionIndex], list);
  else $('#exercise-area').innerHTML = '<div class="muted">LecciÃ³n completa ðŸŽ‰</div>';
}

/* ------------------------
   Dictionary
   ------------------------ */
function renderDictionary(){
  const listEl = $('#dict-list'); if (!listEl) return;
  listEl.innerHTML = '';
  data.dictionary.forEach(w=>{
    const d = document.createElement('div'); d.className='dictionary-item';
    d.innerHTML = `<div><strong>${w.spanish}</strong> â€” <em>${w.wayu}</em></div>`;
    const right = document.createElement('div');
    const play = document.createElement('button'); play.className='btn small'; play.textContent='ðŸ”Š';
    play.onclick = ()=> speak(w.wayu);
    right.appendChild(play);
    d.appendChild(right);
    listEl.appendChild(d);
  });
  $('#dict-search').oninput = ()=>{
    const q = $('#dict-search').value.trim().toLowerCase();
    const filtered = data.dictionary.filter(d=>!q || d.spanish.toLowerCase().includes(q) || d.wayu.toLowerCase().includes(q));
    listEl.innerHTML = '';
    filtered.forEach(w=>{
      const d = document.createElement('div'); d.className='dictionary-item';
      d.innerHTML = `<div><strong>${w.spanish}</strong> â€” <em>${w.wayu}</em></div>`;
      const right = document.createElement('div');
      const play = document.createElement('button'); play.className='btn small'; play.textContent='ðŸ”Š';
      play.onclick = ()=> speak(w.wayu);
      right.appendChild(play);
      d.appendChild(right);
      listEl.appendChild(d);
    });
  };
}

/* ------------------------
   Admin functions
   ------------------------ */
$('#create-level').onclick = ()=> {
  if (!checkAdmin()) return;
  const name = $('#new-level-name').value.trim(), desc = $('#new-level-desc').value.trim();
  if (!name) return alert('Nombre requerido');
  data.levels.push({ id: genId(), name, desc });
  saveData(data); $('#new-level-name').value=''; $('#new-level-desc').value=''; renderLevels(); renderAdminSelect();
};

$('#create-lesson').onclick = ()=>{
  if (!checkAdmin()) return;
  const levelId = $('#sel-level').value; const title = $('#new-lesson-title').value.trim(), body = $('#new-lesson-body').value.trim();
  if (!levelId || !title) return alert('Seleccione nivel y tÃ­tulo');
  data.lessons.push({ id: genId(), levelId, title, body });
  saveData(data); $('#new-lesson-title').value=''; $('#new-lesson-body').value=''; alert('LecciÃ³n creada'); renderLevels();
};

$('#create-word').onclick = ()=>{
  if (!checkAdmin()) return;
  const es = $('#dict-es').value.trim(), wy = $('#dict-wy').value.trim();
  if (!es || !wy) return alert('Complete campos');
  data.dictionary.push({ id: genId(), spanish:es, wayu:wy });
  saveData(data); $('#dict-es').value=''; $('#dict-wy').value=''; renderDictionary();
};

$('#seed-demo').onclick = ()=> {
  if (!checkAdmin()) return;
  seedDemo(true);
  alert('Contenido de ejemplo cargado.');
};
$('#clear-data').onclick = ()=> {
  if (!checkAdmin()) return;
  if (!confirm('Eliminar todos los datos locales (usuarios, contenido)?')) return;
  localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(USER_KEY); location.reload();
};

/* populate admin level select */
function renderAdminSelect(){
  const sel = $('#sel-level'); if(!sel) return;
  sel.innerHTML = '';
  data.levels.forEach(l=>{ const o = document.createElement('option'); o.value = l.id; o.textContent = l.name; sel.appendChild(o); });
}

/* check admin */
function checkAdmin(){
  if (!state.currentUser) return alert('Inicie sesiÃ³n como administrador.');
  const u = data.users[state.currentUser];
  if (!u || !u.isAdmin) return alert('Acceso restringido: requiere rol admin.');
  return true;
}

/* ------------------------
   Profile
   ------------------------ */
$('#save-profile').onclick = ()=>{
  if (!state.currentUser) return alert('Inicie sesiÃ³n primero.');
  const u = data.users[state.currentUser];
  const name = $('#profile-name').value.trim(); const initials = $('#profile-initials').value.trim();
  if (name) u.username = name;
  if (initials) u.initials = initials.toUpperCase();
  data.users[state.currentUser] = u; saveData(data); alert('Perfil guardado'); renderSideNavInfo();
};

/* ------------------------
   Export / Import
   ------------------------ */
function exportImportDialog(){
  const json = JSON.stringify(data, null, 2);
  if (confirm('Â¿Desea copiar los datos actuales al portapapeles? (Aceptar) â€” Cancelar para importar JSON)')){
    navigator.clipboard.writeText(json).then(()=>alert('Datos copiados al portapapeles.'));
  } else {
    const imported = prompt('Pegue aquÃ­ el JSON para importar:');
    if (imported){
      try { data = JSON.parse(imported); saveData(data); alert('Importado correctamente â€” se recargarÃ¡ la interfaz.'); location.reload(); } catch(e){ alert('JSON invÃ¡lido.'); }
    }
  }
}

/* ------------------------
   Helpers
   ------------------------ */
function genId(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function initialsFrom(name){ return name.split(' ').map(n=>n[0]).slice(0,2).join('').toUpperCase(); }
function speak(text){
  if (!text) return;
  if ('speechSynthesis' in window){
    const ut = new SpeechSynthesisUtterance(text);
    // si contiene caracteres no latinos, poner 'es-CO' todavÃ­a funciona para la demo
    ut.lang = 'es-CO';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(ut);
  } else {
    alert(text);
  }
}

/* ------------------------
   Seed demo content (Wayuunaiki samples)
   ------------------------ */
function seedDemo(force=false){
  // if not force and data has levels, skip
  if (!force && data.levels.length>0) return;
  data = { users: {}, levels: [], lessons: [], exercises: [], dictionary: [], results:{} };

  // create sample admin user
  data.users['admin'] = { username:'admin', pass:'admin123', initials:'AD', isAdmin:true, xp:120, level:2, streak:4, completed:[], lastLessonId:null, createdAt:Date.now() };
  data.users['juan'] = { username:'juan', pass:'1234', initials:'JM', isAdmin:false, xp:30, level:1, streak:2, completed:[], lastLessonId:null, createdAt:Date.now() };

  // levels
  const lvl1 = { id: genId(), name:'BÃ¡sico 1', desc:'Saludos, presentaciones y saludos cotidianos' };
  const lvl2 = { id: genId(), name:'Intermedio 1', desc:'Familia, rutinas y tiempo' };
  const lvl3 = { id: genId(), name:'Cultura WayÃºu', desc:'Frases y expresiones culturales' };
  data.levels.push(lvl1,lvl2,lvl3);

  // lessons
  const les1 = { id: genId(), levelId: lvl1.id, title:'Saludos', body:'Saludos bÃ¡sicos en Wayuunaiki' };
  const les2 = { id: genId(), levelId: lvl1.id, title:'Presentaciones', body:'Decir su nombre y preguntar por otro' };
  const les3 = { id: genId(), levelId: lvl2.id, title:'Familia', body:'Miembros de la familia' };
  data.lessons.push(les1,les2,les3);

  // exercises sample
  data.exercises.push({
    id: genId(), lessonId: les1.id, type:'mcq',
    prompt:'Â¿CÃ³mo se dice "Hola" en Wayuunaiki?',
    options:['Ashajawaa','Washi','SÃ¼chi'], correctIndex:0, xp:12
  });
  data.exercises.push({
    id: genId(), lessonId: les1.id, type:'text',
    prompt:'Traduce al espaÃ±ol: "Ashajawaa"', answer:'Hola', xp:10
  });
  data.exercises.push({
    id: genId(), lessonId: les2.id, type:'mcq',
    prompt:'Â¿CuÃ¡l es una forma de presentarse?',
    options:['Yo soy...', 'Â¿DÃ³nde estÃ¡...?', 'Gracias'], correctIndex:0, xp:10
  });
  data.exercises.push({
    id: genId(), lessonId: les3.id, type:'listen',
    prompt:'Piichi', answer:'Piichi', xp:10 // listen: reproduce la palabra (TTS)
  });

  // dictionary
  data.dictionary.push({ id: genId(), spanish:'Hola', wayu:'Ashajawaa' });
  data.dictionary.push({ id: genId(), spanish:'Madre', wayu:'Piichi' });
  data.dictionary.push({ id: genId(), spanish:'Agua', wayu:'WÃ¼in' });
  data.dictionary.push({ id: genId(), spanish:'Gracias', wayu:'Jinain' });

  saveData(data); renderLevels(); renderDictionary(); renderAdminSelect();
}

/* ------------------------
   Misc bindings
   ------------------------ */
function bindButtons(){
  // lesson/views nav
  $('#close-lesson').onclick = ()=> { $('#lesson-area').hidden=true; }
  // side nav initial binding (already in bindSideNav)
  // search dictionary key handled in renderDictionary
}

/* Expose global for debugging if desea */
window.WL = { data, saveData, seedDemo, genId };

/* Final render/update */
renderSideNavInfo();
renderTopActions();
renderLevels();
renderDictionary();
renderAdminSelect();

</script>
</body>
</html>


